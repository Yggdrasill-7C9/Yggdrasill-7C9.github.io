<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/icon.png"/>
	 <link rel="shortcut icon" href="/img/icon.png">
	
			
    <title>
    温故而知新
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    
    	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>

			    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<link rel="stylesheet" href="/css/prism-funky.css" type="text/css"></head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">亚古兽进化！</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/Http/">Http</a></li><li><a class="category-link" href="/categories/Linux/">Linux</a></li><li><a class="category-link" href="/categories/git-svn/">git&svn</a></li><li><a class="category-link" href="/categories/iOS开发/">iOS开发</a></li><li><a class="category-link" href="/categories/ios开发/">ios开发</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        <li class="active">
	            <a href="#s1">归档</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="archive-link" href="/archives/2018/01/">January 2018</a></li><li><a class="archive-link" href="/archives/2017/12/">December 2017</a></li><li><a class="archive-link" href="/archives/2014/01/">January 2014</a></li><li><a class="archive-link" href="/archives/2013/04/">April 2013</a>
	                    </ul>
	        </li>
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/tag/" title="标签">
		                标签
		            </a>
		        </li>
		        
		        <li>
		            <a href="/group/" title="友情链接">
		                友情链接
		            </a>
		        </li>
		        
		        <li>
		            <a href="/about/" title="about">
		                about
		            </a>
		        </li>
		        
		        <li>
		            <a href="/gallery/" title="图库">
		                图库
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
		            
		            
		            
		            
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url();background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 > 闭包、lambda 计算、block</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <h1 id="block"><a href="#block" class="headerlink" title="block"></a>block</h1><p>导读：</p>
<ul>
<li>什么是 block？</li>
<li>block 基本原理是什么？</li>
<li>使用 block 需要避免哪些问题？</li>
</ul>
<p>##1、什么是 block</p>
<p>###（1）Block</p>
<p>block 概念：block是带有<strong>自动变量值</strong>的<strong>匿名函数</strong>。也称为闭包（closure）、lambda 计算。</p>
<p>C语言的标注不允许存在这样的函数，但是可以通过函数指针来直接调用函数。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// 声明一个函数</span>
<span class="token keyword">int</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>      

<span class="token comment" spellcheck="true">// 声明一个函数指针，并取出 func 的地址赋给 *funcP</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>funcP<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>func<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//注：函数形参可有可无，视情况而定</span>

<span class="token comment" spellcheck="true">// 通过函数名访问这个函数</span>
<span class="token keyword">int</span> result1 <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   

<span class="token comment" spellcheck="true">// 通过函数的指针访问这个函数</span>
<span class="token keyword">int</span> result2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>funcP<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="（2）函数指针的用途："><a href="#（2）函数指针的用途：" class="headerlink" title="（2）函数指针的用途："></a>（2）函数指针的用途：</h3><p>函数指针的用途有两个：</p>
<ul>
<li>调用函数</li>
<li>作为函数的参数</li>
</ul>
<blockquote>
<pre class=" language-c++"><code class="language-c++">Class* a; // a 是个对象，类型是指针
Class *a; // a 是个指针，类型是类

/* 
*  虽然上述写法均表示声明一个指针型变量，但是着重点不同。
*  前者意在声明一个变量，后者意在声明一个指针。
*  这种自行体会就好，不要拘泥于写法。
*/
</code></pre>
</blockquote>
<h3 id="（3）悬浮指针的出现及避免"><a href="#（3）悬浮指针的出现及避免" class="headerlink" title="（3）悬浮指针的出现及避免"></a>（3）悬浮指针的出现及避免</h3><p>声明一个指针需要注意的问题：</p>
<ul>
<li>避免出现<strong>悬浮指针</strong>（也称迷途指针、失控指针）</li>
</ul>
<p>悬浮指针的出现：dealloc 一个指针后，没有把指针置空（nil）。</p>
<p><em>如果再次调用该指针并没有重新赋值，就会出现问题</em>。</p>
<blockquote>
<p>注意：空指针 ！= 迷途指针。空指针指向的地址为空。</p>
<p>指针的指针即本身</p>
</blockquote>
<h3 id="（4）函数中可能使用的变量："><a href="#（4）函数中可能使用的变量：" class="headerlink" title="（4）函数中可能使用的变量："></a>（4）函数中可能使用的变量：</h3><ul>
<li><p>函数的参数</p>
</li>
<li><p>局部变量（自动变量）</p>
</li>
<li><p>静态变量（静态局部变量）</p>
</li>
<li><p>全局变量</p>
</li>
<li><p>静态全局变量</p>
<blockquote>
<p>使用全局变量会占用更多的内存（因为其生命期长），不过在计算机配置很高的今天，这个不应该算什么问题，除非使用的是巨大对象的全局变量，能避免就一定要避免。</p>
</blockquote>
</li>
</ul>
<h3 id="（5）OC-中函数和方法的区别"><a href="#（5）OC-中函数和方法的区别" class="headerlink" title="（5）OC 中函数和方法的区别"></a>（5）OC 中函数和方法的区别</h3><p>函数和对象无关，方法和对象有关。最主要的是，函数和方法写法不一样啊！</p>
<blockquote>
<p>函数是指把一个值通过一系列计算得到一个新的值。</p>
<p>而方法更多考虑的是事情。如让一个人通过一系列动作制造一个新的东西。</p>
</blockquote>
<h3 id="（6）为什么-Block-可以作为函数参数和返回值？"><a href="#（6）为什么-Block-可以作为函数参数和返回值？" class="headerlink" title="（6）为什么 Block 可以作为函数参数和返回值？"></a>（6）为什么 Block 可以作为函数参数和返回值？</h3><p>函数的参数和返回值可以是 void、int，也可以是一个类对象，当然也可以是指针（int<em> char</em>）。而 block 为什么可以作为函数的参数甚至是返回值呢？</p>
<p><strong>因为block的本质是 OC 对象。</strong>（OC 的 层面）</p>
<p>block的实质是<strong>栈</strong>上 block 的结构体实例。（C 的层面）这里也可以理解为是一个函数指针。</p>
<blockquote>
<pre class=" language-objective-c"><code class="language-objective-c">typedef int(^blk_t)(int); // 声明一个参数为 int 型、返回值为 int 型的 blk_t类型
blk_t blk = ^(int count){return count+1;};// 声明一个 blk 变量
int (^blk)(int) = ^(int count){return count+1;};// 等价于第二行

blk_t *blkptr = &blk;// 声明一个名为 blkptr 的 blk_t型的指针，并指向 blk 的地址。

(*blkptr)(10); // 利用指针调用这个 blk
blk(10); // 直接调用这个 blk
</code></pre>
</blockquote>
<h3 id="（7）-block-说明符"><a href="#（7）-block-说明符" class="headerlink" title="（7）__block 说明符"></a>（7）__block 说明符</h3><p>引入<code>__block</code>的目的是用来声明变量的作用域的，意思就是 block 外用<code>__block</code>声明的变量，block 内也能访问到。虽然这货和全局变量有些类似，但是老机器全局变量用多了会导致浪费内存啊！（因为全局变量生命周期比较长）。</p>
<p>吐槽：乖乖用__block吧，特大的对象做全局变量的时候，也是会出现问题的。</p>
<h3 id="（8）block-的实质"><a href="#（8）block-的实质" class="headerlink" title="（8）block 的实质"></a>（8）block 的实质</h3><p>block的实质是<strong>栈</strong>上 block 的结构体实例。（吐槽，说白了就是通过指针访问的）</p>
<p>（写一个代码用 clang rewrite 一下就明白了，因为有 Foundation 框架，一个5行的代码能重写成将近10万行。。不过核心代码在最后几行，翻到最后看就可以了）</p>
<blockquote>
<p>重写代码的时候会发现有三个结构体，一个是<code>__block_imp1</code>另一个是<code>__main_block_imp1_0</code>还有一个是<code>__main_block_desc_0</code></p>
<p>这里面引申一个概念就是 IMP 和SEL，具体以后再分析(runtime)，知道SEL 表示（选择器） IMP 表示<em>函数指针</em>就可以了。</p>
</blockquote>
<p><code>__block</code>的实质是栈上<code>__block</code>变量的结构体实例。</p>
<pre class=" language-objective-c"><code class="language-objective-c">// block的实质结构
typedef objc_class *Class; //Class 为 objc_class 结构体的指针类型

typedef struct objc_object{
  Class isa;
} *id; //id为 objc_objec 结构体的指针类型
</code></pre>
<p>将 block源码转换为 C++源码：<code>clang -rewrite-objc filename</code></p>
<table>
<thead>
<tr>
<th>__block变量的配置存储域</th>
<th>Block 从栈复制到堆是的影响</th>
</tr>
</thead>
<tbody>
<tr>
<td>栈（stack）</td>
<td>从栈复制到堆并被 Block 持有</td>
</tr>
<tr>
<td>堆（heap/maclloc）</td>
<td>被 Block 持有</td>
</tr>
</tbody>
</table>
<p>栈上的 block ：变量作用域结束时，栈上的 __block变量和 block 被废弃</p>
<p>堆上的 block：变量作用域结束时不受影响，需要手动释放。 </p>
<h2 id="block-循环引用的问题"><a href="#block-循环引用的问题" class="headerlink" title="block 循环引用的问题"></a>block 循环引用的问题</h2><p>如果在 Block 中使用__strong修饰的对象和变量，那么当 Block 从栈复制到堆上的时候，该对象就会被 Block所持有。这样就会引起循环引用。</p>
<blockquote>
<p>循环引用这里有个重点，Block 是存储在栈上的，普通对象和变量是存储在堆上的。堆（malloc）上的内存需要我们手动管理（需要 dealloc），而栈上的内存顾名思义是按照数据结构中栈的方式管理，即由系统进行分配。</p>
</blockquote>
<p><strong>对象持有 block =&gt; block持有 self =&gt; self 持有对象，即形成循环引用。</strong>（这里的 self 也包含当前类的其他属性，因为在调用属性的同时也截获了 self）。</p>
<blockquote>
<p>编译器能查出循环引用。</p>
</blockquote>
<h2 id="copy-release"><a href="#copy-release" class="headerlink" title="copy release"></a>copy release</h2><p>ARC 无效的时候，我们需要手动将 Block 从栈复制到堆。</p>
<p>因为 ARC 无效，所以需要我们手动释放复制的 Block。</p>
<p>这个时候我们用 copy 方法来复制，release 方法来释放。</p>
<pre class=" language-objective-c"><code class="language-objective-c">void (^block_on_heap)(void) = [block_on_stack copy];//正常复制

[block_on_heap release];//正常释放

[block_on_heap retain]; // 因为block 在堆上，所以可以被 retain

[block_on_stack retain];// 因为现在 block 在栈上，所以这个方法没用
</code></pre>
<blockquote>
<p>ARC 是苹果公司在iOS 5 以后推出的内存管理机制。。iOS 5以前是手动管理的。。如果还问我 ARC 的话，那我基本不考虑你们公司了。。。。</p>
</blockquote>
<h2 id="block的作用"><a href="#block的作用" class="headerlink" title="__block的作用"></a>__block的作用</h2><p>ARC 无效__block用来避免 Block 中出现的循环引用。</p>
<p>栈——&gt;堆时：__block修饰的变量不会被 retain。没用它修饰的就会被 retain。</p>
<h2 id="ARC"><a href="#ARC" class="headerlink" title="ARC"></a>ARC</h2><table>
<thead>
<tr>
<th>对象操作</th>
<th>OC 方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>生成并持有对象</td>
<td>+ alloc、+ new、copy、mutableCopy</td>
</tr>
<tr>
<td>持有对象</td>
<td>- retain</td>
</tr>
<tr>
<td>释放对象</td>
<td>- release</td>
</tr>
<tr>
<td>废弃对象</td>
<td>- dealloc</td>
</tr>
</tbody>
</table>
<h2 id="strong-和-weak"><a href="#strong-和-weak" class="headerlink" title="__strong 和 __weak"></a><code>__strong</code> 和 <code>__weak</code></h2><p>__strong：表示对对象的强引用。即在超出其作用域被废弃时，随着强引用的释放，引用的对象也会被释放。</p>
<h2 id="内存泄露"><a href="#内存泄露" class="headerlink" title="内存泄露"></a>内存泄露</h2><p>循环引用容易导致内存泄露。内存泄露就是应当废弃的对象在超出其生存周期后继续存在。</p>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-Ydddrasill-7C9'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://Yggdrasill-7C9.github.io/2018/01/15/iOS开发/iOS 开发基础/闭包、lambda-计算、block/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'https://Yggdrasill-7C9.github.io/2018/01/15/iOS开发/iOS 开发基础/闭包、lambda-计算、block/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-Ydddrasill-7C9.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
            </ul>
            
            	<span id="busuanzi_container_site_pv">2018总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
