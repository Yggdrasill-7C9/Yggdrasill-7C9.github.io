---
title: 深入学习多线程编程
date: 2018-01-21 13:47:32
tags:
---



共享数据时 

@synchronize（self）{  // 括号内表示的是锁对象，需要全局只创建一次，所以一般用 self 

​    // 操作

}



## 一、NSThread

### 1、创建线程

```objective-c
NSThread *thread = [[NSThread alloc] initWithTarget:self selector:@selector(downloadWithURL:) object:@"传入的参数"];

[thread start]; // 启动线程
```

### 2、分离线程（创建线程并启动）

```objective-c
 [NSThread detachNewThreadSelector:@selector(downloadWithURL:) toTarget:self withObject:@"thread3：detach"];
```

### 3、隐式创建一个线程

```objective-c
performSelectorInBackground:
```

### 4、常见方法：

``` objective-c
// 获取当前线程
[NSThread currentThread];
// 获取主线程
[NSThread mainThread];
```

### 5、睡眠（暂停）线程；死亡

```objective-c
+ (void)sleepUntilDate:(NSDate):date;
+ (void)sleepForTimeInterval(NSTimeInterVal)ti;

+ (void)exit; // 线程死亡，并释放内存
```

### 6、互斥锁、同步锁（@synchronize）

① 目的：为了防止多个线程访问同一块内存（数据），从而造成数据竞争的问题。

②使用：

```objective-c
// 因为只需要一把锁，所以需要一个静态全局锁对象(保证只创建一次)，一般我们用 self 代替。
@synchronize（LockObject）{  
    // 操作
}

```

③作用：一个线程获得锁以后，会阻塞其他想要访问此锁的线程，知道该锁被释放。

④其他锁：

> 1. NSLock
> 2. NSRecursiveLock
> 3. NSCondition
> 4. NSConditionLock
> 5. pthread_mutex
> 6. pthread_rwlock
> 7. POSIX Conditions
> 8. OSSpinLock (自旋锁)
> 9. os_unfair_lock
> 10. dispatch_semaphore （信号量）
> 11. @synchronized （互斥锁 ）

[1]: http://www.cocoachina.com/ios/20161129/18216.html	" iOS 的各种锁"

### 7、线程通讯



### 8、注意事项：

① 不要同时开太多线程（1~3条即可，最好不要超过5条）

② 主线程：UI 线程；（因为属性都是 非原子性的，为了线程安全，所以不要在子线程更新 UI ）

​     子线程：后台线程；（执行耗时操作 ）



## 二、GCD

1、同步与异步：sync、async （执行）决定要不要开启多线程

* 同步：只能在当前线程中执行任务，不具备开启新线程的能力；（不常用）
* 异步：可以在新的线程中执行任务，具备开新线程的能力； （开发中一般只需要考虑异步串行队列和异步并行队列）

2、队列：并发队列、串行队列（concurrent、serial）（队列）决定执行顺序 

* 并发队列：可以让多个任务并发执行(同步执行)，自动开启多个线程执行任务。（所以并发队列异步执行才有效）。一般同时开多条线程 （取决于 CPU 调度）
* 串行队列：让任务一个接一个执行。一般  只开一条线程。（取决于 CPU 调度     ）

3、主队列和全局队列

* main：全局串行队列
* global：全局并发队列

|      | 并发队列（global_queue） | 串行队列           | 主队列（串）     |
| ---- | ------------------ | -------------- | ---------- |
| 同步执行 | 不开启多线程，串行执行        | 不开多线程，串行执行     | 不开多线程，串行执行 |
| 异步执行 | **开启多线程，并发执行**     | **开启多线程，串行执行** | 不开多线程，串行执行 |

 

